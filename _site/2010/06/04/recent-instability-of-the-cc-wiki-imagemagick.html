<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="author" content="Creative Commons">
      <meta name="viewport" content="width=device-width">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap-theme.min.css">
      <link rel="stylesheet" href="/css/main.css">
      <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
      <link rel="icon" href="/favicon.ico" type="image/x-icon">
      <link rel="alternate" type="application/atom+xml" href="/atom.xml">
      <title>Recent instability of the CC Wiki: ImageMagick?&mdash;Creative Commons Labs</title>
   </head>
   
   <body>

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Creative Commons Labs</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/blog">Read our blog</a></li>
            <li><a href="/contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

<div class="container">

      <div class="starter-template">

	<h1><a href="/">Creative Commons Labs</a></h1>

	<p><small>Website of the Creative Commons tech team.
</small>
	</p>

      </div>

      <div class="row">

	<div class="col-md-12">

  	<div class="post">

  
  <div class="bg-danger text-center" id="old-posts">
    <p>Please note, this is an old blog post from several years ago. It may contain out of date information. If you spot anything broken or missing, <a target="_blank" href="https://github.com/creativecommons/labs/issues">please file a bug</a>.</p>
  </div>
  

  <header class="post-header">
    <h1 class="post-title">Recent instability of the CC Wiki: ImageMagick?</h1>
    <p class="post-meta">Jun 4, 2010 by nkinkade</p>
  </header>

  <article class="post-content">
    <p>For the past few weeks we have been having some intermittent but fairly serious problems with the machine that runs the CC Wiki.  Every few days it would just crash and burn, and not being able to login, the only remedy was a reboot.  The system and application logs were very silent on the cause.</p>
<p>A day or two ago <a href="http://purl.org/NET/JesseW/SundryStuff/">Jesse Weinstein</a> (who helps CC greatly by monitoring the CC Wiki and keeping down spam) wrote to say that he was getting 503 errors from the wiki.  I explained that we were having problems, but that it should be working at that moment.  He wrote back to mention that /Special:NewFiles was still returning a 503.  Sure<br />
enough, not only did it return a 503, but it hung for 30s to a minute, and eventually <a href="http://varnish-cache.org/">Varnish</a> would return the 503 error.</p>
<p>Mediawiki debugging was not terribly explicit, but I did notice that the logging for such a request always ended with information about Mediawiki invoking ImageMagick to resize an image.  I went through our LocalSettings.php file and found that we had $wgUseImageMagick set to true.  I commented it out, and voil√†, the page starting working.  I uncommented $wgUseImageMagick and then bumped $wgMaxShellMemory to an arbitrarily high number.  This fixed it too.  Apparently ImageMagick was running out of allowed memory causing not only the page to hang while it ate up memory, but apparently it was also taking down the Apache process with it, because Apache never even got to logging the request.   I couldn't think of why we'd be using ImageMagick instead of just using PHP's GD libraries, which seemed to work without any special settings or bumping $wgMaxShellMemory, so I just removed the use of ImageMagick.</p>
<p>I'm guessing our problem was something like this: bots and crawlers were hitting the /Special:NewFiles page repeatedly with an incremental &from= query parameter, and each Apache process would hang until eventually we reached Apache's MaxClients setting, then requests would start to back up in Varnish's queue, and the machine would slow to a crawl and eventually become unresponsive.</p>
<p>Hopefully this supposition is true, and we not only have a fully functional wiki again, but the systemic problems with the server are now resolved.</p>

  </article>

</div>


	</div>

      </div>
      

    <footer>

    <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a></p>

    <p>Except where otherwise noted, content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</p>

    </footer>

    </div><!-- /.container -->

    <script async src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script async src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>

  </body>
</html>
